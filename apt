#!/bin/bash

# å±é™©å‘½ä»¤åˆ—è¡¨ï¼ˆè§¦å‘å¤‡ä»½ï¼‰
DANGEROUS_CMDS=("install" "autopurge" "purge" "full-upgrade" "dist-upgrade" "remove")

# æ£€æŸ¥å½“å‰å‘½ä»¤æ˜¯å¦éœ€è¦å¤‡ä»½
need_backup() {
    for cmd in "${DANGEROUS_CMDS[@]}"; do
        if [[ "$1" == "$cmd" ]]; then
            return 0
        fi
    done
    return 1
}

# åˆ›å»ºTimeshiftå¿«ç…§ï¼ˆç§»é™¤äº†--tagså‚æ•°ï¼‰
create_snapshot() {
    local cmd=$1
    echo -e "\033[1;33mâš ï¸  å³å°†æ‰§è¡Œå±é™©æ“ä½œ: sudo apt $cmd"
    echo "ğŸ”„ æ­£åœ¨åˆ›å»ºç³»ç»Ÿå¿«ç…§... (çº¦1-5åˆ†é’Ÿ)\033[0m"
    
    TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
    SNAPSHOT_NAME="Pre-APT_${cmd}_${TIMESTAMP}"
    
    # ç§»é™¤äº†--tagså‚æ•°
    if ! sudo timeshift --create --comments "$SNAPSHOT_NAME"; then
        echo -e "\033[1;31mâŒ å¿«ç…§åˆ›å»ºå¤±è´¥ï¼æ˜¯å¦ç»§ç»­ï¼Ÿ [y/N]\033[0m"
        read -r confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            echo "æ“ä½œå·²å–æ¶ˆ"
            exit 1
        fi
    fi
}

# ä¸»é€»è¾‘
if need_backup "$1"; then
    # æ£€æŸ¥Timeshiftæ˜¯å¦å®‰è£…
    if ! command -v timeshift &> /dev/null; then
        echo -e "\033[1;31mâœ– Timeshiftæœªå®‰è£…ï¼è¯·å…ˆå®‰è£…:"
        echo "sudo add-apt-repository -y ppa:teejee2008/ppa"
        echo "sudo apt update && sudo apt install -y timeshift\033[0m"
        exit 1
    fi
    
    create_snapshot "$1"
fi

# æ‰§è¡ŒåŸå§‹aptå‘½ä»¤
exec /usr/bin/apt.real "$@"
